<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Canvasでお描き！！</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <style>
    #mycanvas {
      border: 10px solid #999;
      cursor: crosshair;
    }
    .thumbnail {
      border: 2px solid #999;
      margin-right: 5px;
    }
  </style>
</head>
<body>
  <p>
    <select id="penColor">
      <option value="black">黒</option>
      <option value="red">赤</option>
      <option value="blue">青</option>
      <option value="white">白</option>
    </select>
    <select id="penWidth">
      <option value="1">細</option>
      <option value="3">中</option>
      <option value="5">太</option>
    </select>
    <input type="button" id="erase" value="消去">
    <input type="button" id="save" value="ギャラリーに追加">
  </p>
  <canvas width="400" height="200" id="mycanvas">
    Canvasに対応していないときにこのメッセージが出ちゃいます(´；ω；｀)
  </canvas>
  <div id="gallery"></div>
  <script>
    $(function(){
      var canvas = document.getElementById('mycanvas');
      if (!canvas || !canvas.getContext) return false; //Canvasが使えない古いブラウザ用
      var ctx = canvas.getContext('2d');

      var startX, // クリックした座標X
          startY, // クリックした座標Y
          x, // クリックを離した座標X
          y, // クリックを離した座標Y
          borderWidth = 10,
          isDrawing = false;

      $('#mycanvas').mousedown(function(e){ // クリックしたとき
        isDrawing = true;
        startX = e.pageX - $(this).offset().left - borderWidth;
        startY = e.pageY - $(this).offset().top - borderWidth;
      })
      .mousemove(function(e){ // マウスを動かしたとき
        if (!isDrawing) return;
        x = e.pageX - $(this).offset().left - borderWidth;
        y = e.pageY - $(this).offset().top - borderWidth;

        ctx.beginPath();
        ctx.moveTo(startX, startY);
        ctx.lineTo(x, y);
        ctx.stroke();

        startX = x;
        startY = y;
      })
      .mouseup(function(){ // クリックを離したとき
        isDrawing = false;
      })
      .mouseleave(function(){ // マウスが離れたとき
        isDrawing = false;
      });

      $("#penColor").change(function(){
        ctx.strokeStyle = $(this).val();
      });
      $("#penWidth").change(function(){
        ctx.lineWidth = $(this).val();
      });
      $("#erase").click(function(){
        if(!confirm('本当に消去しますか？')) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      });

      $("#save").click(function(){
        var img = $('<img>').attr({
          width: 100,
          height: 50,
          src: canvas.toDataURL() // ブラウザによって動かない
        });
        var link = $('<a>').attr({
          href: canvas.toDataURL().replace('image/png', 'application/octet-stream'),
          download: new Date().getTime() + '.png' // ダウンロードファイル名
        });
        $('#gallery').append(link.append(img.addClass('thumbnail')));
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      });
    });
  </script>
  
</body>
</html>